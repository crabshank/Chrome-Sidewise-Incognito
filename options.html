<!DOCTYPE html>
<html>
<head>
    <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title i18n="optionsPageTitle"></title>

    <link type="text/css" rel="stylesheet" href="/css/reset.css"/>
    <link type="text/css" rel="stylesheet" href="/css/options.css"/>
    <link rel='shortcut icon' href="images/sidewise_icon_16.png" type="image/x-icon" />
    <link href='http://fonts.googleapis.com/css?family=Lobster' rel='stylesheet' type='text/css'>

    <script type="text/javascript" src="/js/jquery/jquery-1.7.2.min.js"></script>
    <script type="text/javascript" src="/js/jquery/jquery.tools.min.js"></script>
    <script type='text/javascript' src='/js/jquery/jquery.highlight.js'></script>

    <script type="text/javascript" src="/js/lib/util/settings.js"></script>
    <script type="text/javascript" src="/js/lib/util/logging.js"></script>
    <script type="text/javascript" src="/js/lib/util/i18n.js"></script>
    <script type="text/javascript" src="/js/lib/util/detect-monitors.js"></script>
    <script type="text/javascript" src="/js/lib/util/chrome-functions.js"></script>

    <script>
    function transformInputElements() {
        var elems = $('input, select');
        elems.each(function(i, e) {
            var $e = $(e);
            var name = e.attributes.name.value;
            var type = $e.attr('type') || e.tagName.toLowerCase();
            var msgName = 'option_' + name;
            var label = getMessage(msgName);
            var labelElem = $('<div class="optionsLabel">')
                .append($('<label/>', { for: name }).text(label));

            var units = getMessage(msgName + '_units');
            if (units) {
                var unitsElem = $('<span class="optionsUnits"/>').text(units);
            }
            else {
                var unitsElem = $('');
            }

            var hint = getMessage(msgName + '_hint');
            if (hint) {
                var hintClass = 'hintIcon';
                if (hint[0] == '!') {
                    hint = hint.slice(1);
                    hintClass = 'warningIcon';
                }
                var hintElem = $('<div/>', { class: hintClass, title: hint })
                    .tooltip({ position: 'top right' }).dynamic();
            }
            else {
                var hintElem = $('');
            }

            var inputElem = $e.clone();
            inputElem.attr('id', name);

            var inputBox = $('<div class="optionsInputBox"/>');

            var rep = $('<div class="optionsRow"/>');
            switch (type) {
                case 'text':
                    inputBox.append(inputElem).append(unitsElem);
                    rep.append(labelElem).append(inputBox);
                    break;
                case 'checkbox':
                    labelElem.append(hintElem);
                    inputBox.append(inputElem).append(labelElem);
                    rep.append(inputBox);
                    break;
                case 'button':
                    inputElem.val(label);
                    rep.append(inputElem);
                    break;
                case 'select':
                    inputBox.append(inputElem).append(hintElem);
                    rep.append(labelElem).append(inputBox);
                    break;
                default:
                    throw 'Unsupported input element type, cannot transform: ' + type;
            }

            $e.replaceWith(rep);
        });
    }

    function loadSettings() {
        var elems = $('input, select');
        elems.each(function(i, e) {
            var $e = $(e);
            var type = $e.attr('type') || e.tagName.toLowerCase();
            var name = $e.attr('name');
            var value = loadSetting(name);

            switch (type) {
                case 'button':
                    return;
                    break;

                case 'checkbox':
                    e.checked = value;
                    break;

                default:
                    $e.val(value);
                    break;
            }
        });
    }

    function saveOneSetting(e) {
        var $e = $(e);
        var name = $e.attr('name');
        var value = e.value;
        var type = $e.attr('type') || e.tagName.toLowerCase();
        var datatype = $e.attr('datatype');
        var storeValue;

        // validate
        var valid = true;

        switch (type) {
            case 'button':
                // ignore for purposes of saving settings
                return;
                break;

            case 'text':
                switch (datatype) {
                    case 'int':
                        storeValue = parseInt(value);
                        if (storeValue.toString() != value) {
                            valid = false;
                            break;
                        }
                        break;

                    default:
                        storeValue = value;
                        break;
                }
                break;

            case 'checkbox':
                storeValue = e.checked;
                break;

            default:
                storeValue = value;
                break;
        }

        if (!valid) {
            return false;
        }

        saveSetting(name, storeValue);
        return true;
    }

    function onSettingModified(evt) {
        var target = evt.target;
        var $target = $(target);
        if (saveOneSetting(target)) {
            $target.removeClass('invalid');
            showStatusMessage(getMessage('optionsSuccessSavingSetting'));
            updateStateFromSettings();
            return;
        }

        $target.addClass('invalid');
        showErrorMessage(getMessage('optionsErrorSavingSetting'));
    }

    function saveAllSettings(evt) {
        $('input').each(function(i, e) {
            saveOneSetting(e);
        });
        showStatusMessage(getMessage('optionsSavedAllSettings'));
    }

    function showStatusMessage(msg) {
        $('#statusBar').addClass('statusOK').removeClass('statusError')
            .highlight({ start_color: '#c2d2e3', end_color: '#e7edf4', delay: 2000 });
        $('#statusMessage')
            // .stop().animate({opacity:'100'})
            .text(msg)
            .show(); //.fadeOut(2000);
    }

    function showErrorMessage(msg) {
        $('#statusBar').removeClass('statusOK').addClass('statusError')
            .highlight({ start_color: '#edd', end_color: '#fee', delay: 2000 });
        // $('#statusMessage').stop().animate({opacity:'100'});
        $('#statusMessage').text(msg).show();
    }

    function detectMonitors() {
        retrieveMonitorMetrics(function(monitors, maxOffset) {
            saveMonitorMetrics(monitors, maxOffset);
            updateStateFromSettings();
            setMonitorCountInfo(monitors.length);
            showStatusMessage(getMessage('prompt_detectMonitors_complete'));
        });
    }

    function setMonitorCountInfo(count) {
        $('#infoMonitorsOnYourSystem').html(
            getMessage('optionsInfoMonitorsOnYourSystem',
                [count,
                    (count == 1 ? getMessage('text_monitor') : getMessage('text_monitors'))
                ]
            )
        );
    }

    $(document).ready(function() {
        setI18NText();
        transformInputElements();
        loadSettings();

        $('#version').text(getMessage('text_Version') + ' ' + getVersion());
        setMonitorCountInfo(loadSetting('monitorMetrics').length);

        $(document).on('change', 'input[type=text], select', onSettingModified);
        $(document).on('click', 'input[type=checkbox]', onSettingModified);
        $(document).on('click', '#saveButton', saveAllSettings);
        $(document).on('click', '#detectMonitorsButton', detectMonitors);
        setTimeout(function() {
            // delay to avoid F5 (reload) spuriously triggering this
            $(document).on('keyup', 'input[type=text]', onSettingModified);
        }, 250);
    });
    </script>
</head>
<body>
<div id="top">
    <div id="pageContainer">
        <header>
            <div id="version"></div>
            <h1 i18n="optionsPageHeading"></h1>
        </header>

        <div id="statusBar" class="statusOK"><div id="statusMessage" i18n="optionsDefaultStatus"></div></div>

        <div id="optionsContainer">

            <h2 i18n="optionsHeadingSidebar"></h2>
            <input type="checkbox" name="openSidebarOnStartup"/>
            <input type="checkbox" name="keepSidebarOnTop"/>
            <select name="dockState">
                <option value="left" i18n="option_dockState_left"/>
                <option value="right" i18n="option_dockState_right"/>
                <option value="undocked" i18n="option_dockState_undocked"/>
            </select>
            <select name="browserActionButtonBehavior">
                <option value="toggle" i18n="option_browserActionButtonBehavior_toggle"/>
                <option value="show" i18n="option_browserActionButtonBehavior_show"/>
            </select>

            <h2 i18n="optionsHeadingMonitors"></h2>
            <div class="optionsRow">
                <div class="info" i18n="optionsInfoMonitorDetection"></div>
            </div>
            <input type="button" id="detectMonitorsButton" name="detectMonitorsButton"/>
            <div class="optionsRow">
                <span class="info" id="infoMonitorsOnYourSystem"></span>
            </div>
            <h2 i18n="optionsHeadingMisc"></h2>
                <input type="checkbox" name="loggingEnabled"/>

            <div id="saveBox" align="right">
                <div class="hint" i18n="optionsSaveNotNeeded"></div>
                <input type="button" id="saveButton" name="saveButton"/>
            </div>
        </div>
    </div>
</div>
<div id="clouds">
    <div id="clouds_1"></div>
    <div id="clouds_2"></div>
    <div id="clouds_3"></div>
    <div id="clouds_4"></div>
</div>

</body>
</html>
